(window.webpackJsonp=window.webpackJsonp||[]).push([[161],{744:function(t,a,s){"use strict";s.r(a);var n=s(7),e=Object(n.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("p",[t._v("消息队列是最古老的中间件之一，从系统之间有通信需求开始，就自然产生了消息队列。如果你还没有用过消息队列，那是时候好好学习一下了。本文告诉什么是消息队列，为什么需要消息队列，常见的消息队列有哪些， RabbitMQ 的部署和使用。")]),t._v(" "),s("h2",{attrs:{id:"什么是消息队列"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#什么是消息队列"}},[t._v("#")]),t._v(" 什么是消息队列")]),t._v(" "),s("p",[t._v("消息队列拆开了看，就是消息 + 队列，消息是什么？其实就是程序之间通讯所用到的数据，消息从生产者那里产生，进入队列后，安装设计好的规则出队，由消费者消费。仅此而已。")]),t._v(" "),s("h2",{attrs:{id:"为什么需要消息队列"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#为什么需要消息队列"}},[t._v("#")]),t._v(" 为什么需要消息队列")]),t._v(" "),s("p",[t._v("消息队列，最重要的是队列，可以想象一下没有队列的场景，你去银行办业务的时候，大家都不排队的场景，大家都堆在一起，个子小没力气的根本办不了业务。")]),t._v(" "),s("p",[t._v("如果没有消息队列，你的系统将严重耦合，在升级维护的时候牵一发而动全身。")]),t._v(" "),s("p",[t._v("如果没有消息队列，你的系统的很多功能都是同步的，同步意味着前面的事件完成后，才可以进行后续的操作，前端用户的会觉得卡顿，体验很差。")]),t._v(" "),s("p",[t._v("如果没有消息队列，web 系统突然面对高并发的访问请求，可能会崩溃。")]),t._v(" "),s("p",[t._v("有了消息队列，系统解耦、异步通信、流量削峰、延迟通知、最终一致性保证、顺序消息、流式处理等需求都可以轻松解决。")]),t._v(" "),s("h2",{attrs:{id:"常见的消息队列"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#常见的消息队列"}},[t._v("#")]),t._v(" 常见的消息队列")]),t._v(" "),s("p",[t._v("比较常见的消息队列产品主要有 ActiveMQ、RabbitMQ、ZeroMQ、Kafka、RocketMQ 等。")]),t._v(" "),s("p",[s("strong",[t._v("ActiveMQ")])]),t._v(" "),s("p",[t._v("Apache ActiveMQ 是 Apache 软件基金会所研发的开放源码消息中间件；由于 ActiveMQ 是一个纯Java程序，因此只需要操作系统支持 Java 虚拟机，ActiveMQ 便可执行。")]),t._v(" "),s("ul",[s("li",[t._v("支持Java消息服务 (JMS) 1.1 版本")]),t._v(" "),s("li",[t._v("Spring Framework")]),t._v(" "),s("li",[t._v("集群 (Clustering)")]),t._v(" "),s("li",[t._v("协议支持包括：OpenWire、REST、STOMP、WS-Notification、MQTT、XMPP 以及 AMQP")])]),t._v(" "),s("p",[s("strong",[t._v("RabbitMQ")])]),t._v(" "),s("p",[t._v("RabbitMQ 实现了高级消息队列协议（AMQP）的开源消息代理软件（亦称面向消息的中间件）。RabbitMQ 服务器是用高性能、健壮以及可伸缩性出名的 Erlang 语言编写的，支持所有主流的操作系统如 Linux，Windows，MacOS。客户端支持所有主要的编程语言。")]),t._v(" "),s("ul",[s("li",[t._v("可伸缩性：集群服务")]),t._v(" "),s("li",[t._v("消息持久化：从内存持久化消息到硬盘，再从硬盘加载到内存")])]),t._v(" "),s("p",[s("strong",[t._v("ZeroMQ")]),t._v("\nZeroMQ（也拼写作 0MQ 或 ZMQ )是一个为可伸缩的分布式或并发应用程序设计的高性能异步消息库。它提供一个消息队列, 但是与面向消息的中间件不同，ZeroMQ 的运行不需要专门的消息代理（message broker）。该库设计成常见的套接字风格的API。")]),t._v(" "),s("p",[t._v("ZeroMQ 是由 iMatix 公司和大量贡献者组成的社群共同开发的。ZeroQ 通过许多第三方软件支持大部分流行的编程语言，从 Java 和Python 到 Erlang 和 Haskell。")]),t._v(" "),s("p",[s("strong",[t._v("Kafka")])]),t._v(" "),s("p",[t._v("Kafka 是由 Apache 软件基金会开发的一个开源流处理平台，由 Scala 和 Java 编写。该项目的目标是为处理实时数据提供一个统一、高吞吐、低延迟的平台。其持久化层本质上是一个“按照分布式事务日志架构的大规模发布/订阅消息队列”，这使它作为企业级基础设施来处理流式数据非常有价值。此外，Kafka 可以通过 Kafka Connect 连接到外部系统（用于数据输入/输出），并提供了 Kafka Streams 的流式处理库。该设计受事务日志的影响较大。")]),t._v(" "),s("p",[s("strong",[t._v("RocketMQ")])]),t._v(" "),s("p",[t._v("RocketMQ 是一个分布式消息和流数据平台，具有低延迟、高性能、高可靠性、万亿级容量和灵活的可扩展性。RocketMQ 是 2012 年阿里巴巴开源的第三代分布式消息中间件，2016 年 11 月 21 日，阿里巴巴向 Apache 软件基金会捐赠了 RocketMQ；第二年 2 月 20 日，Apache 软件基金会宣布 Apache RocketMQ 成为顶级项目。")]),t._v(" "),s("p",[t._v("消息队列的选型需要根据具体应用需求而定，ZeroMQ 小而美，RabbitMQ 大而稳，Kakfa 和 RocketMQ 快而强劲。")]),t._v(" "),s("h2",{attrs:{id:"rabbitmq-的部署和使用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#rabbitmq-的部署和使用"}},[t._v("#")]),t._v(" RabbitMQ 的部署和使用")]),t._v(" "),s("p",[t._v("推荐 Docker 部署，在安装 Docker 的环境下，执行：")]),t._v(" "),s("div",{staticClass:"language-sh line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[t._v("docker run -d --hostname my-rabbit -p "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("15672")]),t._v(":15672 -p "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("5672")]),t._v(":5672 -- name rabbit-server -e "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("RABBITMQ_DEFAULT_USER")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("user -e "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("RABBITMQ_DEFAULT_PASS")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("password rabbitmq:3-management\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("p",[t._v("现在在浏览器中打开 localhost:15672 。用户名是 user ，密码是 password")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://tva1.sinaimg.cn/large/008i3skNgy1gtqcdvbzxnj61ji0u078o02.jpg",alt:""}})]),t._v(" "),s("p",[t._v("接下来，让我们创建一个队列，名字叫 my_app")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://tva1.sinaimg.cn/large/008i3skNgy1gtqcvbflrsj60u00x6n1602.jpg",alt:""}})]),t._v(" "),s("p",[t._v("创建一个 Exchange，名字叫 my_exchange")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://tva1.sinaimg.cn/large/008i3skNgy1gtqcfkhiyrj61000u00w002.jpg",alt:""}})]),t._v(" "),s("p",[t._v("点击 Exchange 标签页，点击 my_exchange 进入详情页， 将 my_exchange 和 my_app 绑定，路由密钥设置为 test:")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://tva1.sinaimg.cn/large/008i3skNgy1gtqcwqg72yj60u00v3ac002.jpg",alt:""}})]),t._v(" "),s("h3",{attrs:{id:"python-编写生产者"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#python-编写生产者"}},[t._v("#")]),t._v(" Python 编写生产者")]),t._v(" "),s("p",[t._v("现在可以使用 Python 编写生产者，来生产一条消息放入队列，并观察 Web 页面的变动情况：")]),t._v(" "),s("div",{staticClass:"language-python line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" pika\n\nconnection "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" pika"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("BlockingConnection"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pika"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ConnectionParameters"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'localhost'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("5672")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" pika"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("PlainCredentials"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'user'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'password'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nchannel "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" connection"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("channel"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\nchannel"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("basic_publish"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("exchange"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'my_exchange'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" routing_key"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'test'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" body"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Test!'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\nconnection"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("close"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br")])]),s("p",[t._v("执行上面的代码，即可将消息放入队列，这里我执行了四次，可以看到有四条消息：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://tva1.sinaimg.cn/large/008i3skNgy1gtqd1s7txwj614i0k80um02.jpg",alt:""}})]),t._v(" "),s("p",[t._v("消息将保留在队列中，直到消费者把它取出，接下来我们写一个消费消息的程序。")]),t._v(" "),s("h3",{attrs:{id:"python-编写消费者"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#python-编写消费者"}},[t._v("#")]),t._v(" Python 编写消费者")]),t._v(" "),s("div",{staticClass:"language-python line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-python"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" pika\nconnection "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" pika"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("BlockingConnection"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pika"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ConnectionParameters"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'localhost'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("5672")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" pika"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("PlainCredentials"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"user"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"password"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nchannel "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" connection"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("channel"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("callback")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ch"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" method"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" properties"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" body"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("print")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string-interpolation"}},[s("span",{pre:!0,attrs:{class:"token string"}},[t._v("f'")]),s("span",{pre:!0,attrs:{class:"token interpolation"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("body"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v(" is received'")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\nchannel"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("basic_consume"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("queue"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"my_app"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" on_message_callback"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("callback"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" auto_ack"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("True")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nchannel"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("start_consuming"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br")])]),s("p",[t._v("执行：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://tva1.sinaimg.cn/large/008i3skNgy1gtqd4acssrj60lc07iq3f02.jpg",alt:""}})]),t._v(" "),s("p",[t._v("此时，队列已经空了：")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://tva1.sinaimg.cn/large/008i3skNgy1gtqd5g91a8j614c08wq3u02.jpg",alt:""}})]),t._v(" "),s("p",[t._v("这段代码最低限度地演示了如何将消息发布到 RabbitMQ 中，更多用法还请移步到官方文档。")]),t._v(" "),s("h2",{attrs:{id:"最后的话"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#最后的话"}},[t._v("#")]),t._v(" 最后的话")]),t._v(" "),s("p",[t._v("消息队列可以进行系统模块之间的解耦，但自己就成了关键节点，在集群部署和故障转移方面，需要系统管理员的大量关注。本文简要介绍了什么是消息队列，为什么需要消息队列，常见的消息队列有哪些，RabbitMQ 的部署和使用，如果对你有所帮助，请点赞支持，如有问题留言讨论。")])])}),[],!1,null,null,null);a.default=e.exports}}]);